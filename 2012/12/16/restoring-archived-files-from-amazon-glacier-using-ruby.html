<!DOCTYPE html>
<html lang='en' manifest='/offline.appcache'>
<head>
<meta charset='utf-8'>
<title>
Sascha Faun Winter
</title>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<meta content='Personal portfolio and blog of Sascha Faun Winter' name='description'>
<meta content='Sascha Faun Winter' name='author'>
<link href="/stylesheets/application.css" media="all" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Roboto:400,900" media="all" rel="stylesheet" type="text/css" />
<!-- [if lt IE 9] ><script src="/javascripts/html5.js" type="text/javascript"></script><! [endif] -->
<link href="/assets/ico/favicon.ico" rel="icon" type="image/ico" />
<link href='/assets/ico/apple-touch-icon-144x144-precomposed.png' rel='apple-touch-icon-precomposed' sizes='144x144'>
<link href='/assets/ico/apple-touch-icon-114x114-precomposed.png' rel='apple-touch-icon-precomposed' sizes='114x114'>
<link href='/assets/ico/apple-touch-icon-72x72-precomposed.png' rel='apple-touch-icon-precomposed' sizes='72x72'>
<link href='/assets/ico/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'>
<link href='https://plus.google.com/u/0/112681783906373636049' rel='author'>
</head>
<body>
<header class='navbar navbar-fixed-top navbar-inverse'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-collapse' data-toggle='collapse' type='button'>
<span class='sr-only'>Toggle navigation</span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
</div>
<div class='container'>
<div class='navbar-inner'>
<nav class='collapse navbar-collapse'>
<ul class='nav navbar-nav'>
<li>
<a href="/">Home</a>
</li>
<li>
<a href="/resume.html">Resume</a>
</li>
<li>
<a href="/contact.html">Contact</a>
</li>
</ul>
</nav>
</div>
</div>
</header>

<div class='2012/12/16/restoring-archived-files-from-amazon-glacier-using-ruby container'>
<div class='row'>
<div class='container'>
<h1 class='page-title'>
Restoring Archived Files from Amazon Glacier
</h1>
<aside class='attribution'>
by
<a rel="me" href="https://twitter.com/faunzy">Sascha Faun Winter</a>
</aside>
<div class='section center-block'>
<article>
<h3>The Problem</h3>

<p>A few weeks ago I got into a situation in which I needed to restore a large number of files from Amazon&rsquo;s then-new service: S3 Archive (Glacier). These objects (Amazon&rsquo;s word for files), are not standard Glacier objects, but are S3 objects that have been <a href="http://docs.amazonwebservices.com/AmazonS3/latest/dev/object-lifecycle-mgmt.html">transitioned</a> to long-term storage. You can read more about Glacier <a href="http://aws.amazon.com/glacier/">here</a>.</p>

<h6>The Other Problem</h6>

<p>Normally you could restore these objects in the AWS console, but being a new service, Amazon didn&rsquo;t consider the use case of restoring files in bulk across the multiple directories presented in the AWS console. Yes, I know S3 doesn&rsquo;t have directories, they only have objects. However, the objects are presented as if they were folders in the AWS management console. Every slash is translated into a directory that can be traversed and scrolled though. You can scroll though directories using their awkward, slow web interface that the returns to the top of the listing every time you navigate in and out of a folder, making the prospect of restoring these files a multi-month proposition. This meant that the console was out of the question. So that meant writing a script using the Amazon Web Services API.</p>

<h3>The Solution</h3>

<p>I had two options for writing a script to restore these objects: </p>

<ol>
<li>Use the Java SDK provided by Amazon</li>
<li>Write something myself since the Amazon Ruby SDKs are out of date and the existing Ruby libraries had not yet been updated to work with S3 archived object and don&rsquo;t offer you a way to make an arbitrary POST request (that I could tell).</li>
</ol>

<p>So I set out to use the standard S3 API v2 (which I was using in the app I was working on) to restore these objects using a signed POST request to <code>object_name?restore</code> to the specified object. Below is that script I cranked out during a sleepless state of delirium.</p>

<h3>Usage:</h3>

<p>Make a file called <code>files_to_restore.txt</code> in the same directory as the <code>glacier_restore.rb</code> file shown in the gist below.
Add your files in the format (one object per line, no leading slash, no bucket name):</p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>sub/folder/object_1.ext
another/sub/folder/object_2.ext
</pre></td></tr></tbody></table></code></pre></div>
<p>run:</p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ruby glacier_restore.rb &gt; out.txt 2&gt;err.txt
</pre></td></tr></tbody></table></code></pre></div>
<p>or, to resume a stopped job:</p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ruby glacier_restore.rb &gt;&gt; out.txt 2&gt;&gt;err.txt
</pre></td></tr></tbody></table></code></pre></div>
<h3>tl;dr</h3>

<p>This script can be used to restore Amazon S3 objects that were archived using the <a href="http://docs.amazonwebservices.com/AmazonS3/latest/UG/LifecycleConfiguration.html">lifecycle</a> feature of Amazon S3. </p>

<h3>Disclaimer</h3>

<p>This is an ugly piece of code that I found useful for a short period of time. Hence I do not intend to maintain this script. I share it only in the hopes that restoring files from S3 archive is less painful for you than it was for me. I used this script to restore tens of thousands of objects before Amazon was able to step in and take over with a script that they had written themselves. Best of luck!</p>

<h3>License</h3>

<p>Copyright Â© 2012 Sascha Winter</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &ldquo;Software&rdquo;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED &ldquo;AS IS&rdquo;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>

<hr>

<h3>Further Reading:</h3>

<p>See the <a href="http://docs.amazonwebservices.com/AmazonS3/latest/API/RESTObjectPOSTrestore.html">RESTObjectPOSTrestore</a> and <a href="http://docs.amazonwebservices.com/AmazonS3/latest/dev/restoring-objects.html">restoring-objects</a> for more info.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env ruby</span>
<span class="nb">require</span> <span class="s1">'base64'</span>
<span class="nb">require</span> <span class="s1">'openssl'</span>
<span class="nb">require</span> <span class="s1">'digest/sha1'</span>
<span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s2">"uri"</span>
<span class="nb">require</span> <span class="s1">'time'</span>

<span class="no">DEBUG</span> <span class="o">=</span> <span class="kp">false</span>

<span class="k">class</span> <span class="nc">GlacierRestore</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@request_params</span> <span class="o">=</span><span class="s1">'?restore'</span>
    <span class="vi">@bucket</span> <span class="o">=</span> <span class="s1">'[[bucket name]]'</span>
    <span class="vi">@host</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@bucket</span><span class="si">}</span><span class="s2">.s3.amazonaws.com"</span>
    <span class="vi">@access_key_id</span> <span class="o">=</span> <span class="s1">'[[access key id]]'</span>
    <span class="vi">@secret_access_key</span> <span class="o">=</span> <span class="s1">'[[your secret access key]]'</span>
    <span class="vi">@post_body</span> <span class="o">=</span> <span class="s2">"&lt;RestoreRequest&gt;</span><span class="se">\n</span><span class="s2">  &lt;Days&gt;[[num_days]]&lt;/Days&gt;</span><span class="se">\n</span><span class="s2">&lt;/RestoreRequest&gt;"</span>
    <span class="vi">@md5</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="p">.</span><span class="nf">base64digest</span><span class="p">(</span><span class="vi">@post_body</span><span class="p">)</span>
    <span class="vi">@content_type</span> <span class="o">=</span> <span class="s2">"text/xml"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">restore</span> <span class="n">files</span>
    <span class="n">files</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
      <span class="n">restore_file</span> <span class="n">file</span><span class="p">.</span><span class="nf">chomp</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">restore_file</span> <span class="n">file_name</span>
    <span class="vi">@date</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">httpdate</span>
    <span class="vi">@canonicalized_resource</span> <span class="o">=</span> <span class="s2">"/</span><span class="si">#{</span><span class="n">file_name</span><span class="si">}#{</span><span class="vi">@request_params</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">string_to_sign</span> <span class="o">=</span> <span class="s2">"POST</span><span class="se">\n</span><span class="si">#{</span><span class="vi">@md5</span><span class="si">}</span><span class="se">\n</span><span class="si">#{</span><span class="vi">@content_type</span><span class="si">}</span><span class="se">\n</span><span class="si">#{</span><span class="vi">@date</span><span class="si">}</span><span class="se">\n</span><span class="s2">/</span><span class="si">#{</span><span class="vi">@bucket</span><span class="si">}#{</span><span class="vi">@canonicalized_resource</span><span class="si">}</span><span class="s2">"</span>
    <span class="vi">@signature</span> <span class="o">=</span> <span class="n">signature</span> <span class="n">string_to_sign</span>

    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"http://</span><span class="si">#{</span><span class="vi">@host</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"http://</span><span class="si">#{</span><span class="vi">@host</span><span class="si">}#{</span><span class="vi">@canonicalized_resource</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'Host'</span><span class="p">,</span> <span class="vi">@host</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">,</span> <span class="s2">"AWS </span><span class="si">#{</span><span class="vi">@access_key_id</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@signature</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="vi">@content_type</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'Content-Length'</span><span class="p">,</span> <span class="vi">@post_body</span><span class="p">.</span><span class="nf">length</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'Date'</span><span class="p">,</span> <span class="vi">@date</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'Content-MD5'</span><span class="p">,</span> <span class="vi">@md5</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="vi">@post_body</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">divider</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">===========</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">if</span> <span class="no">DEBUG</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Headers:</span><span class="se">\n</span><span class="s2"> "</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">to_hash</span><span class="si">}</span><span class="s2">"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Date:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="vi">@date</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Object name:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Canonicalized Resource:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="vi">@canonicalized_resource</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"String to sign:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="n">string_to_sign</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"POST body:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="vi">@post_body</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Response body:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Response message:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="n">response</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Response code:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="si">}</span><span class="s2">'"</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">divider</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Signature:</span><span class="se">\n</span><span class="s2">'</span><span class="si">#{</span><span class="vi">@signature</span><span class="si">}</span><span class="s2">'"</span>
    <span class="k">else</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">response</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/&lt;.*?&gt;/</span><span class="p">,</span> <span class="s1">' '</span><span class="p">).</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/ +/</span><span class="p">,</span> <span class="s1">' '</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">409</span><span class="p">].</span><span class="nf">include?</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="p">.</span><span class="nf">to_i</span><span class="p">)</span>
      <span class="vg">$stdout</span><span class="p">.</span><span class="nf">puts</span> <span class="n">file_name</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signature</span> <span class="n">string_to_sign</span>
    <span class="no">Base64</span><span class="p">.</span><span class="nf">encode64</span><span class="p">(</span>
      <span class="no">OpenSSL</span><span class="o">::</span><span class="no">HMAC</span><span class="p">.</span><span class="nf">digest</span><span class="p">(</span>
        <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">Digest</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">),</span>
        <span class="vi">@secret_access_key</span><span class="p">,</span> <span class="n">string_to_sign</span><span class="p">)</span>
    <span class="p">).</span><span class="nf">chomp</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">if</span> <span class="kp">__FILE__</span> <span class="o">==</span> <span class="vg">$0</span>
  <span class="n">glacier</span> <span class="o">=</span> <span class="no">GlacierRestore</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">files</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'files_to_restore.txt'</span><span class="p">).</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">to_a</span>
  <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Restoring </span><span class="si">#{</span><span class="n">files</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2"> files"</span>
  <span class="c1">#if you only want to parse some of the lines</span>
  <span class="c1">#files = files[1..10]</span>
  <span class="n">glacier</span><span class="p">.</span><span class="nf">restore</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
</article>
</div>
<hr>
<aside>
<nav>
<a class='btn btn-default' href='/'>âBack</a>
</nav>
</aside>

</div>
</div>
</div>
<script src='https://code.jquery.com/jquery-2.1.1.min.js' type='text/javascript'></script>
<script src="/javascripts/application.js" type="text/javascript"></script>
<script>
  // Google analytics
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11110028-1']);
  _gaq.push(['_trackPageview']);
  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https://ssl.google-analytics.com/ga.js');
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  // Appcache brute-force refresh
  if (window.applicationCache) {
    applicationCache.addEventListener('updateready', function() {
      window.location.reload();
    });
  }
</script>
</body>
</html>

